<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mocap Demoï½œBVH / GLB â†’ è§’è‰²é‡å®šå‘</title>
<style>
  :root { --bg:#0f1115; --panel:#161922; --text:#e8e8ea; --muted:#9aa0a6; --acc:#4f8cff; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto}
  #app{position:fixed;inset:0}
  #ui{
    position:fixed;left:12px;top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    padding:10px 12px;background:rgba(22,25,34,.9);backdrop-filter:blur(8px);border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.35);max-width:min(96vw,1200px);z-index:10
  }
  #ui .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  #ui label{font-size:12px;color:var(--muted)}
  #ui input[type="file"], select, button, input[type="range"], input[type="checkbox"]{accent-color:var(--acc)}
  select,button{background:#111523;border:1px solid #283044;color:var(--text);border-radius:10px;padding:8px 10px;font-size:14px}
  button:hover{border-color:#3b4a6b;cursor:pointer}
  #status{font-size:12px;color:var(--muted)}
  #drop{position:fixed;inset:0;pointer-events:none;border:2px dashed transparent;border-radius:18px}
  #drop.active{pointer-events:none;border-color:#3b82f6;box-shadow:0 0 0 999vmax rgba(59,130,246,.08) inset}
  #errorToast{
    position:fixed;right:12px;bottom:12px;max-width:min(96vw,560px);
    padding:10px 12px;background:#301b1b;color:#ffd7d7;border:1px solid #5f2c2c;border-radius:12px;display:none;white-space:pre-wrap;line-height:1.4
  }
  .badge{padding:2px 8px;border-radius:999px;background:#23283a;color:#b8c1ff;font-size:12px}
</style>
</head>
<body>
<div id="app"></div>

<div id="ui">
  <div class="row">
    <span class="badge">Step 1</span>
    <button id="btnLoadModel">è¼‰å…¥é è¨­è§’è‰²ï¼ˆ./character.glbï¼‰</button>
    <label>æˆ–ä¸Šå‚³è§’è‰² <input id="charInput" type="file" accept=".glb,.gltf"/></label>
    <button id="btnLoadRobot">ä¸€éµç”¨ RobotExpressive</button>
    <button id="btnLoadSoldier">ä¸€éµç”¨ Soldier</button>
    <span id="status">åˆå§‹åŒ–ä¸­â€¦</span>
  </div>

  <div class="row" style="width:100%">
    <span class="badge">Step 2</span>
    <label>ä¸Šå‚³å‹•ä½œï¼ˆ.bvh æˆ– .glbï¼‰
      <input id="motionInput" type="file" accept=".bvh,.glb,.gltf" multiple/>
    </label>
    <button id="btnLoadSamples">ä¸€éµè¼‰å…¥ç¤ºç¯„å‹•ä½œï¼ˆWalk/Run/Jumpï¼‰</button>
  </div>

  <div class="row" style="width:100%">
    <label>å‹•ä½œæ¸…å–®
      <select id="motionSelect" style="min-width:260px">
        <option disabled selected>ï¼ˆå°šæœªè¼‰å…¥å‹•ä½œï¼‰</option>
      </select>
    </label>
    <button id="playBtn">æ’­æ”¾</button>
    <button id="pauseBtn">æš«åœ</button>
    <label>å¾ªç’° <input id="loopChk" type="checkbox" checked/></label>
    <label style="display:flex;align-items:center;gap:6px">é€Ÿåº¦
      <input id="speed" type="range" min="0.1" max="2.0" step="0.05" value="1"/>
    </label>
  </div>
</div>

<div id="drop"></div>
<div id="errorToast"></div>

<!-- âœ… es-module-shimsï¼ˆä¸€å®šè¦åœ¨æœ€å‰é¢å¼•å…¥ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/es-module-shims@1/dist/es-module-shims.min.js"></script>

<!-- âœ… ç”¨ importmap-shimï¼ˆä¸æ˜¯ importmapï¼‰ -->
<script type="importmap-shim">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js",
    "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/"
  }
}
</script>

<!-- âœ… ç”¨ module-shimï¼ˆä¸æ˜¯ moduleï¼‰ -->
<script type="module-shim">
import * as THREE from 'three';
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';
import { BVHLoader } from 'three/examples/jsm/loaders/BVHLoader.js';
import * as SkeletonUtils from 'three/examples/jsm/utils/SkeletonUtils.js';

/* ---- å¸¸ç”¨é ç«¯æ¨¡å‹ URL ---- */
const ROBOT_URL = "https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/RobotExpressive/glTF-Binary/RobotExpressive.glb";
const SOLDIER_URL = "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/models/gltf/Soldier.glb";

/* ---- DOM ---- */
const app = document.getElementById("app");
const statusEl = document.getElementById("status");
const btnLoadModel = document.getElementById("btnLoadModel");
const btnLoadRobot = document.getElementById("btnLoadRobot");
const btnLoadSoldier = document.getElementById("btnLoadSoldier");
const charInput = document.getElementById("charInput");
const motionInput = document.getElementById("motionInput");
const motionSelect = document.getElementById("motionSelect");
const playBtn = document.getElementById("playBtn");
const pauseBtn = document.getElementById("pauseBtn");
const loopChk = document.getElementById("loopChk");
const speed = document.getElementById("speed");
const drop = document.getElementById("drop");
const errorToast = document.getElementById("errorToast");

/* ---- State ---- */
let renderer, scene, camera, controls, clock = new THREE.Clock();
let model, targetSkeleton, mixer;
const actions = new Map();
let currentAction = null;

/* ---- Init ---- */
init().catch(showFatal);

async function init(){
  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  renderer.setSize(innerWidth, innerHeight);
  renderer.shadowMap.enabled = true;
  app.appendChild(renderer.domElement);

  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0f1115);

  camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, .1, 100);
  camera.position.set(0,1.6,3);

  controls = new OrbitControls(camera, renderer.domElement);
  controls.target.set(0,1,0);
  controls.update();

  const hemi = new THREE.HemisphereLight(0xffffff, 0x202035, .9);
  scene.add(hemi);
  const dir = new THREE.DirectionalLight(0xffffff, 1.2);
  dir.position.set(3,5,2);
  dir.castShadow = true;
  dir.shadow.mapSize.set(2048,2048);
  scene.add(dir);

  const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(30,30),
    new THREE.MeshStandardMaterial({color:0x171a24, roughness:1})
  );
  floor.rotation.x = -Math.PI/2;
  floor.receiveShadow = true;
  scene.add(floor);

  window.addEventListener("resize", onResize);

  btnLoadModel.addEventListener("click", ()=>loadCharacterFromURL("./character.glb"));
  btnLoadRobot.addEventListener("click", ()=>loadCharacterFromURL(ROBOT_URL, "RobotExpressive"));
  btnLoadSoldier.addEventListener("click", ()=>loadCharacterFromURL(SOLDIER_URL, "Soldier"));

  charInput.addEventListener("change", e=>{
    const f = e.target.files?.[0]; if(!f) return;
    loadCharacterFromFile(f);
  });

  motionInput.addEventListener("change", e=>{
    if(!ensureModel()) return;
    const files = [...(e.target.files||[])];
    loadMultipleMotions(files);
  });

  document.getElementById("btnLoadSamples").addEventListener("click", async ()=>{
    if(!ensureModel()) return;
    try{
      setStatus("è¼‰å…¥ç¤ºç¯„å‹•ä½œä¸­â€¦");
      const samples = [
        {name:"Walk (07_01)", url:"https://raw.githubusercontent.com/una-dinosauria/cmu-mocap/master/data/007/07_01.bvh"},
        {name:"Run (09_01)",  url:"https://raw.githubusercontent.com/una-dinosauria/cmu-mocap/master/data/009/09_01.bvh"},
        {name:"Jump (13_39)", url:"https://raw.githubusercontent.com/una-dinosauria/cmu-mocap/master/data/013/13_39.bvh"}
      ];
      for(const s of samples){ await loadBVHFromURL(s.url, s.name); }
      setStatus(`å·²è¼‰å…¥ ${actions.size} æ”¯å‹•ä½œ`);
      if(actions.size && !currentAction){
        const first = actions.keys().next().value;
        motionSelect.value = first;
        switchToAction(first, 0.0);
      }
    }catch(err){ showError("ç¤ºç¯„å‹•ä½œè¼‰å…¥å¤±æ•—ï¼š" + (err?.message||err)); }
  });

  motionSelect.addEventListener("change", ()=>{
    const name = motionSelect.value;
    switchToAction(name, 0.35);
  });
  playBtn.addEventListener("click", ()=>{ currentAction?.play(); currentAction && (currentAction.paused=false); setStatus("æ’­æ”¾"); });
  pauseBtn.addEventListener("click", ()=>{ if(currentAction){ currentAction.paused = true; setStatus("æš«åœ"); }});
  speed.addEventListener("input", ()=>{ if(mixer) mixer.timeScale = Number(speed.value); });
  loopChk.addEventListener("change", ()=>{
    for(const a of actions.values()){
      a.setLoop(loopChk.checked ? THREE.LoopRepeat : THREE.LoopOnce, Infinity);
      a.clampWhenFinished = !loopChk.checked;
    }
  });

  window.addEventListener("dragover", e=>{ e.preventDefault(); drop.classList.add("active"); });
  window.addEventListener("dragleave", e=>{ drop.classList.remove("active"); });
  window.addEventListener("drop", e=>{
    e.preventDefault(); drop.classList.remove("active");
    if(!ensureModel()) return;
    const files = [...(e.dataTransfer?.files||[])];
    if(files.length) loadMultipleMotions(files);
  });

  setStatus("è«‹å…ˆè¼‰å…¥è§’è‰²ï¼ˆæŒ‰éˆ•æˆ–ä¸Šå‚³ GLBï¼‰");
  animate();
}

function onResize(){
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
}

/* ---- Loaders ---- */
async function loadCharacterFromURL(url, label){
  try{
    setStatus(`è¼‰å…¥è§’è‰²ä¸­â€¦${label?`ï¼ˆ${label}ï¼‰`:''}`);
    if(!/^https?:/i.test(url)){ // åªæœ‰æœ¬åœ°ç›¸å°è·¯å¾‘æ‰ HEAD æª¢æŸ¥
      try{
        const head = await fetch(url, {method:"HEAD"});
        if(!head.ok) throw new Error(`æ‰¾ä¸åˆ°æª”æ¡ˆ ${url}ï¼ˆHTTP ${head.status}ï¼‰`);
      }catch(e){
        showError("æ‰¾ä¸åˆ°é è¨­è§’è‰²ï¼šè«‹ç¢ºèª `character.glb` èˆ‡ `index.html` åœ¨åŒä¸€å±¤ï¼Œä¸”æª”åå¤§å°å¯«æ­£ç¢ºã€‚");
        throw e;
      }
    }
    const gltf = await new GLTFLoader().loadAsync(url);
    useLoadedCharacter(gltf.scene);
  }catch(err){ showError("è¼‰å…¥è§’è‰²å¤±æ•—ï¼š"+(err?.message||err)); }
}

async function loadCharacterFromFile(file){
  try{
    setStatus("è§£æè§’è‰²æª”â€¦");
    const url = URL.createObjectURL(file);
    const gltf = await new GLTFLoader().loadAsync(url);
    URL.revokeObjectURL(url);
    useLoadedCharacter(gltf.scene);
  }catch(err){ showError("ä¸Šå‚³è§’è‰²å¤±æ•—ï¼š"+(err?.message||err)); }
}

function useLoadedCharacter(sceneObj){
  if(model){ scene.remove(model); mixer?.stopAllAction(); for(const a of actions.values()) a.stop(); actions.clear(); updateMotionSelect(); currentAction=null; targetSkeleton=null; }
  model = sceneObj;
  model.traverse(o=>{
    if(o.isSkinnedMesh){ o.castShadow = true; o.frustumCulled = false; targetSkeleton ??= o.skeleton; }
  });
  if(!targetSkeleton){ throw new Error("æ‰¾ä¸åˆ° SkinnedMesh/Skeletonï¼Œè«‹ç¢ºèªè§’è‰²å·²ç¶éª¨ã€‚"); }
  model.position.set(0,0,0);
  scene.add(model);

  mixer = new THREE.AnimationMixer(model);
  mixer.timeScale = Number(speed.value);

  setStatus("è§’è‰² OKï¼šä¸Šå‚³ .bvh æˆ–å«å‹•ç•«çš„ .glbï¼Œæˆ–é»ã€ä¸€éµè¼‰å…¥ç¤ºç¯„å‹•ä½œã€");
}

function ensureModel(){
  if(!model){ showError("è«‹å…ˆè¼‰å…¥è§’è‰²ï¼ˆæŒ‰éˆ•æˆ–ä¸Šå‚³ GLBï¼‰ã€‚"); return false; }
  return true;
}

async function loadMultipleMotions(files){
  const bvhFiles = files.filter(f=>f.name.toLowerCase().endsWith(".bvh"));
  const glbFiles = files.filter(f=>/\.(glb|gltf)$/i.test(f.name));
  if(bvhFiles.length){ setStatus(`è¼‰å…¥ ${bvhFiles.length} æ”¯ BVHâ€¦`); for(const f of bvhFiles){ await loadBVHFromFile(f).catch(err=>showError(err.message)); } }
  if(glbFiles.length){ setStatus(`è¼‰å…¥ ${glbFiles.length} å€‹ GLB å‹•ä½œä¾†æºâ€¦`); for(const f of glbFiles){ await loadMotionGLB(f).catch(err=>showError(err.message)); } }
  setStatus(`å·²è¼‰å…¥ ${actions.size} æ”¯å‹•ä½œ`);
  if(actions.size && !currentAction){
    const first = actions.keys().next().value;
    motionSelect.value = first;
    switchToAction(first, 0.0);
  }
}

async function loadBVHFromFile(file){
  const url = URL.createObjectURL(file);
  try{
    const res = await new BVHLoader().loadAsync(url);
    addRetargetedClip(res, file.name.replace(/\.(bvh)$/i,""));
  }finally{ URL.revokeObjectURL(url); }
}

async function loadBVHFromURL(url, displayName){
  const res = await new BVHLoader().loadAsync(url);
  addRetargetedClip(res, displayName || url.split("/").pop().replace(/\.(bvh)$/i,""));
}

/* ---- ç›¸å®¹æ‰€æœ‰ BVHLoader å›å‚³æ ¼å¼ ---- */
function addRetargetedClip(bvhResult, name){
  if (!targetSkeleton) throw new Error("å°šæœªè¼‰å…¥è§’è‰²éª¨æ¶ï¼Œç„¡æ³•é‡å®šå‘ BVHã€‚");

  // å®‰å…¨å–å¾— bones é™£åˆ—
  let bonesArray = null;
  if (bvhResult && typeof bvhResult === 'object') {
    const r = bvhResult;
    if (r.skeleton?.bones?.length) bonesArray = r.skeleton.bones;
    else if (r.skeletonHelper?.skeleton?.bones?.length) bonesArray = r.skeletonHelper.skeleton.bones;
    else if (r.skeletonHelper?.bones?.length) bonesArray = r.skeletonHelper.bones;
    else if (Array.isArray(r.bones) && r.bones.length) bonesArray = r.bones;
    else if (r.restPose?.bones?.length) bonesArray = r.restPose.bones;
  }
  if (!bonesArray) {
    showError("BVH æª”æ¡ˆæ²’æœ‰è§£æåˆ° skeletonã€‚\nkeys: " + JSON.stringify(Object.keys(bvhResult||{})));
    throw new Error("BVH ç„¡ bones");
  }

  // åŒ…è£æˆ THREE.Skeleton
  const sourceSkeleton = (bvhResult.skeleton && bvhResult.skeleton.bones === bonesArray)
    ? bvhResult.skeleton
    : new THREE.Skeleton(bonesArray);

  // å–å‹•ç•«ä¸¦ç§»é™¤ root ä½ç§»
  let clip = (bvhResult?.clip && typeof bvhResult.clip.clone === 'function') ? bvhResult.clip.clone() : bvhResult.clip;
  if (!clip) throw new Error("BVH æª”æ¡ˆå…§æ²’æœ‰å¯ç”¨çš„å‹•ç•« clipã€‚");
  clip.tracks = clip.tracks.filter(t => !t.name.endsWith(".position"));

  // é‡å®šå‘
  const retargeted = SkeletonUtils.retargetClip(
    targetSkeleton,
    sourceSkeleton,
    clip,
    { preserveHipPosition: true, useTargetMatrix: true }
  );

  addAction(retargeted, name);
}

async function loadMotionGLB(file){
  const url = URL.createObjectURL(file);
  try{
    const gltf = await new GLTFLoader().loadAsync(url);
    let sourceSkeleton = null;
    gltf.scene.traverse(o=>{ if(o.isSkinnedMesh && !sourceSkeleton){ sourceSkeleton = o.skeleton; }});
    if(!sourceSkeleton || !gltf.animations?.length){
      throw new Error(`GLB ç„¡å¯ç”¨éª¨æ¶/å‹•ç•«ï¼š${file.name}`);
    }
    gltf.animations.forEach((clip, idx)=>{
      const clean = clip.clone();
      clean.tracks = clean.tracks.filter(t=>!t.name.endsWith(".position"));
      const retargeted = SkeletonUtils.retargetClip(
        targetSkeleton, sourceSkeleton, clean,
        { preserveHipPosition:true, useTargetMatrix:true }
      );
      const name = `${file.name.replace(/\.(gltf|glb)$/i,"")} / ${clip.name||("Clip"+idx)}`;
      addAction(retargeted, name);
    });
  }finally{ URL.revokeObjectURL(url); }
}

function addAction(clip, name){
  const action = mixer.clipAction(clip);
  action.enabled = true;
  action.setLoop(loopChk.checked?THREE.LoopRepeat:THREE.LoopOnce, Infinity);
  action.clampWhenFinished = !loopChk.checked;
  action.time = 0;
  action.paused = false;

  actions.set(name, action);
  updateMotionSelect();
}

function updateMotionSelect(){
  motionSelect.innerHTML = "";
  if(!actions.size){
    const opt = document.createElement("option");
    opt.disabled = true; opt.selected = true; opt.textContent="ï¼ˆå°šæœªè¼‰å…¥å‹•ä½œï¼‰";
    motionSelect.appendChild(opt);
    return;
  }
  for(const name of actions.keys()){
    const opt = document.createElement("option");
    opt.value = name; opt.textContent = name;
    motionSelect.appendChild(opt);
  }
}

function switchToAction(name, fade=0.35){
  const next = actions.get(name);
  if(!next){ showError("æ‰¾ä¸åˆ°å‹•ä½œï¼š"+name); return; }
  if(currentAction && currentAction !== next){
    currentAction.crossFadeTo(next.reset().play(), fade, true);
  }else{
    next.reset().play();
  }
  currentAction = next;
  setStatus(`æ’­æ”¾ï¼š${name}`);
}

function setStatus(msg){ statusEl.textContent = msg; }

function animate(){
  requestAnimationFrame(animate);
  const dt = clock.getDelta();
  mixer?.update(dt);
  renderer.render(scene, camera);
}

/* ---- ç°¡æ˜“éŒ¯èª¤é¡¯ç¤º ---- */
function showError(msg){
  console.error(msg);
  setStatus("âš ï¸ " + msg);
  errorToast.textContent = "âš ï¸ " + msg;
  errorToast.style.display = "block";
}
function showFatal(err){
  console.error(err);
  errorToast.textContent = "ğŸš« åˆå§‹åŒ–å¤±æ•—ï¼š\n" + (err?.message || err);
  errorToast.style.display = "block";
  setStatus("ğŸš« åˆå§‹åŒ–å¤±æ•—");
}
window.addEventListener("error", (e)=> showError("è…³æœ¬éŒ¯èª¤ï¼š"+ (e?.message||"unknown")));
window.addEventListener("unhandledrejection", (e)=> showError("Promise éŒ¯èª¤ï¼š"+ (e?.reason?.message || e?.reason || "unknown")));
</script>

<noscript>éœ€è¦å•Ÿç”¨ JavaScript æ‰èƒ½é‹è¡Œæ­¤ Demoã€‚</noscript>
</body>
</html>
